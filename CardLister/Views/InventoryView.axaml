<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FlipKit.Desktop.ViewModels"
             xmlns:models="using:FlipKit.Desktop.Models"
             xmlns:conv="using:FlipKit.Desktop.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
             x:Class="FlipKit.Desktop.Views.InventoryView"
             x:DataType="vm:InventoryViewModel">

    <UserControl.Resources>
        <conv:CurrencyFormatConverter x:Key="CurrencyFormat"/>
        <conv:PriceAgeToColorConverter x:Key="PriceAgeColor"/>
        <conv:StatusToBadgeConverter x:Key="StatusBadge"/>
        <conv:FilePathToBitmapConverter x:Key="FilePathToBitmapConverter"/>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto" ColumnDefinitions="*,Auto" Margin="24">

        <!-- Header -->
        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBlock Text="My Cards" FontSize="24" FontWeight="Bold" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding TotalCount, StringFormat='({0} total)'}"
                           FontSize="16" Opacity="0.6" VerticalAlignment="Center"/>
                <Button Content="{Binding StaleCardCount, StringFormat='Reprice Stale Cards ({0})'}"
                        Command="{Binding NavigateToRepriceCommand}"
                        IsVisible="{Binding StaleCardCount}"
                        Foreground="Red" Padding="12,6" VerticalAlignment="Center"/>
            </StackPanel>
        </StackPanel>

        <!-- Filter Bar -->
        <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Spacing="12" Margin="0,0,0,12">
            <TextBox Text="{Binding SearchText}" Watermark="Search players, brands, teams..."
                     Width="250"/>
            <ComboBox ItemsSource="{Binding SportOptions}" SelectedItem="{Binding SelectedSport}"
                      Width="130"/>
            <ComboBox ItemsSource="{Binding StatusOptions}" SelectedItem="{Binding SelectedStatus}"
                      Width="130"/>
            <Button Content="Refresh" Command="{Binding RefreshCommand}" Padding="16,8"/>
            <Border Width="1" Background="{DynamicResource SystemBaseLowColor}" Margin="4,2"/>
            <Button Content="Select All" Command="{Binding SelectAllCommand}" Padding="12,8" FontSize="12"/>
            <Button Content="Deselect All" Command="{Binding DeselectAllCommand}" Padding="12,8" FontSize="12"/>
            <TextBlock Text="{Binding SelectedCount, StringFormat='{}{0} selected'}"
                       VerticalAlignment="Center" Opacity="0.6" FontSize="12"/>
        </StackPanel>

        <!-- DataGrid (virtualization enabled by default for smooth scrolling) -->
        <DataGrid Grid.Row="2" Grid.Column="0"
                  ItemsSource="{Binding FilteredCards}"
                  SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  SelectionMode="Single">
            <DataGrid.Columns>
                <DataGridTemplateColumn Header="" Width="40">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate x:DataType="models:SelectableCard">
                            <CheckBox IsChecked="{Binding IsSelected}"
                                      HorizontalAlignment="Center" VerticalAlignment="Center"
                                      Command="{Binding $parent[DataGrid].((vm:InventoryViewModel)DataContext).UpdateSelectedCountCommand}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="" Width="40">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate x:DataType="models:SelectableCard">
                            <Image Source="{Binding Card.ImagePathFront, Converter={StaticResource FilePathToBitmapConverter}}"
                                   Width="28" Height="28"
                                   Stretch="UniformToFill"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   IsVisible="{Binding Card.ImagePathFront, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Player" Binding="{Binding Card.PlayerName}" Width="180" IsReadOnly="True"/>
                <DataGridTextColumn Header="Year" Binding="{Binding Card.Year}" Width="60" IsReadOnly="True"/>
                <DataGridTextColumn Header="Brand" Binding="{Binding Card.Brand}" Width="100" IsReadOnly="True"/>
                <DataGridTextColumn Header="Parallel" Binding="{Binding Card.ParallelName}" Width="100" IsReadOnly="True"/>
                <DataGridTextColumn Header="Grade" Binding="{Binding Card.GradeValue}" Width="60" IsReadOnly="True"/>
                <DataGridTextColumn Header="Team" Binding="{Binding Card.Team}" Width="140" IsReadOnly="True"/>
                <DataGridTextColumn Header="Price" Binding="{Binding Card.ListingPrice, Converter={StaticResource CurrencyFormat}, Mode=OneWay}" Width="80" IsReadOnly="True"/>
                <DataGridTemplateColumn Header="Age" Width="50">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate x:DataType="models:SelectableCard">
                            <Ellipse Width="12" Height="12"
                                     Fill="{Binding Card.PriceDate, Converter={StaticResource PriceAgeColor}}"
                                     HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Status" Binding="{Binding Card.Status, Converter={StaticResource StatusBadge}, Mode=OneWay}" Width="80" IsReadOnly="True"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Action Footer -->
        <Border Grid.Row="3" Grid.Column="0" Margin="0,12,0,0"
                Background="{DynamicResource SystemChromeLowColor}"
                CornerRadius="6" Padding="16,10">
            <StackPanel Orientation="Horizontal" Spacing="24">
                <TextBlock>
                    <Run Text="Total:" FontWeight="SemiBold"/>
                    <Run Text="{Binding TotalCount}"/>
                </TextBlock>
                <TextBlock>
                    <Run Text="Priced:" FontWeight="SemiBold"/>
                    <Run Text="{Binding PricedCount}"/>
                </TextBlock>
                <TextBlock>
                    <Run Text="Needs Pricing:" FontWeight="SemiBold"/>
                    <Run Text="{Binding NeedsPricingCount}"/>
                </TextBlock>
                <TextBlock>
                    <Run Text="Value:" FontWeight="SemiBold"/>
                    <Run Text="{Binding TotalValue, StringFormat='\{0:C2\}'}"/>
                </TextBlock>
                <TextBlock>
                    <Run Text="Stale:" FontWeight="SemiBold"/>
                    <Run Text="{Binding StaleCardCount}"/>
                </TextBlock>
                <Button Content="Edit Card" Command="{Binding EditSelectedCommand}"
                        IsEnabled="{Binding HasSelectedItem}"
                        Padding="12,4"/>
                <Button Content="Reprice Card" Command="{Binding RepriceSelectedCommand}"
                        IsEnabled="{Binding HasSelectedItem}"
                        Padding="12,4"/>
                <Button Content="Delete Selected" Command="{Binding RequestDeleteSelectedCommand}"
                        IsEnabled="{Binding HasSelectedItem}"
                        Padding="12,4"/>
                <Button Content="Mark as Sold" Command="{Binding OpenSoldDialogCommand}"
                        IsEnabled="{Binding HasSelectedItem}"
                        Padding="12,4"/>
            </StackPanel>
        </Border>

        <!-- Export Footer -->
        <Border Grid.Row="4" Grid.Column="0" Margin="0,6,0,0"
                Background="{DynamicResource SystemChromeLowColor}"
                CornerRadius="6" Padding="16,10">
            <StackPanel Spacing="6">
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="Export:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <Button Content="Export Selected to CSV" Command="{Binding ExportSelectedCsvCommand}"
                            Padding="12,6"/>
                    <Button Content="Upload Images for Selected" Command="{Binding UploadSelectedImagesCommand}"
                            IsEnabled="{Binding !IsUploading}" Padding="12,6"/>

                    <!-- Upload Progress -->
                    <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsUploading}">
                        <ProgressBar Minimum="0" Maximum="{Binding UploadTotal}" Value="{Binding UploadProgress}" Width="100"/>
                        <TextBlock VerticalAlignment="Center" FontSize="12">
                            <Run Text="{Binding UploadProgress}"/>
                            <Run Text="/"/>
                            <Run Text="{Binding UploadTotal}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Messages -->
                    <TextBlock Text="{Binding ExportMessage}" Foreground="Green" FontSize="12"
                               VerticalAlignment="Center"
                               IsVisible="{Binding ExportMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    <TextBlock Text="{Binding ExportError}" Foreground="Red" FontSize="12"
                               VerticalAlignment="Center"
                               IsVisible="{Binding ExportError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Delete Confirmation Dialog Overlay -->
        <Border Grid.RowSpan="5" IsVisible="{Binding ShowDeleteConfirmDialog}"
                Background="#80000000" CornerRadius="0">
            <Border Background="{DynamicResource SystemChromeLowColor}"
                    BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="12" Padding="30" MaxWidth="380"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="12">
                    <TextBlock Text="Confirm Delete" FontSize="20" FontWeight="Bold"/>
                    <TextBlock TextWrapping="Wrap" Text="{Binding DeleteConfirmMessage}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
                        <Button Content="Cancel" Command="{Binding CancelDeleteCommand}" Padding="16,8"/>
                        <Button Content="Delete" Command="{Binding ConfirmDeleteCommand}"
                                Background="Red" Foreground="White" Padding="16,8"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>

        <!-- Mark as Sold Dialog Overlay -->
        <Border Grid.RowSpan="5" IsVisible="{Binding ShowSoldDialog}"
                Background="#80000000" CornerRadius="0">
            <Border Background="{DynamicResource SystemChromeLowColor}"
                    BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="12" Padding="30" MaxWidth="420"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="12">
                    <TextBlock Text="Mark as Sold" FontSize="20" FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedCard.PlayerName}" FontSize="14" Opacity="0.7"/>

                    <TextBlock Text="Sale Price ($)" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding SoldSalePrice}" Watermark="12.99"/>

                    <TextBlock Text="Platform"/>
                    <ComboBox SelectedItem="{Binding SoldPlatform}" HorizontalAlignment="Stretch">
                        <x:String>Whatnot</x:String>
                        <x:String>eBay</x:String>
                        <x:String>Other</x:String>
                    </ComboBox>

                    <TextBlock Text="Fees ($)"/>
                    <TextBox Text="{Binding SoldFees}" Watermark="Auto-calculated"/>

                    <TextBlock Text="Shipping Cost ($)"/>
                    <TextBox Text="{Binding SoldShippingCost}" Watermark="1.00"/>

                    <TextBlock FontWeight="SemiBold" Foreground="Green">
                        <Run Text="Net Profit: "/>
                        <Run Text="{Binding SoldNetProfit, StringFormat='\{0:C2\}'}"/>
                    </TextBlock>

                    <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
                        <Button Content="Cancel" Command="{Binding CancelSoldDialogCommand}" Padding="16,8"/>
                        <Button Content="Mark as Sold" Command="{Binding ConfirmSoldCommand}"
                                Classes="accent" Padding="16,8"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>

        <!-- Edit Panel (Side Panel) -->
        <Border Grid.Row="0" Grid.RowSpan="5" Grid.Column="1"
                Width="420" Margin="12,0,0,0"
                IsVisible="{Binding IsEditPanelOpen}"
                Background="{DynamicResource SystemChromeLowColor}"
                BorderBrush="{DynamicResource SystemBaseLowColor}"
                BorderThickness="1" CornerRadius="8">
            <Grid RowDefinitions="Auto,*,Auto">
                <!-- Panel Header -->
                <Border Grid.Row="0" Background="{DynamicResource SystemChromeMediumLowColor}"
                        CornerRadius="8,8,0,0" Padding="16,12">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Quick Edit" FontSize="18" FontWeight="Bold"/>
                            <TextBlock Text="{Binding EditingCard.PlayerName}" FontSize="13" Opacity="0.7" Margin="0,2,0,0"/>
                        </StackPanel>
                        <Button Grid.Column="1" Content="âœ•" Command="{Binding CloseEditPanelCommand}"
                                Width="32" Height="32" Padding="0"
                                FontSize="16" VerticalAlignment="Top"/>
                    </Grid>
                </Border>

                <!-- Edit Form (Scrollable) -->
                <ScrollViewer Grid.Row="1" Padding="16">
                    <StackPanel Spacing="12" DataContext="{Binding EditingCard}"
                                x:DataType="vm:CardDetailViewModel">

                        <!-- Player Name -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Player Name *" FontWeight="SemiBold" FontSize="12"/>
                            <TextBox Text="{Binding PlayerName}" Watermark="Required"/>
                        </StackPanel>

                        <!-- Year / Brand / Parallel -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Year" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding Year}" Watermark="2024"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Spacing="4">
                                <TextBlock Text="Card #" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding CardNumber}" Watermark="123"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Spacing="4">
                                <TextBlock Text="Grade" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding GradeValue}" Watermark="10"/>
                            </StackPanel>
                        </Grid>

                        <!-- Brand / Parallel -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Brand" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding Brand}" Watermark="Prizm"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Spacing="4">
                                <TextBlock Text="Parallel" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding ParallelName}" Watermark="Silver"/>
                            </StackPanel>
                        </Grid>

                        <!-- Team / Serial -->
                        <Grid ColumnDefinitions="*,100" ColumnSpacing="8">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Team" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding Team}" Watermark="Team name"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Spacing="4">
                                <TextBlock Text="Serial #" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding SerialNumbered}" Watermark="/99"/>
                            </StackPanel>
                        </Grid>

                        <!-- Checkboxes -->
                        <StackPanel Spacing="6">
                            <CheckBox IsChecked="{Binding IsRookie}" Content="Rookie Card" FontSize="12"/>
                            <CheckBox IsChecked="{Binding IsAuto}" Content="Autograph" FontSize="12"/>
                            <CheckBox IsChecked="{Binding IsRelic}" Content="Relic/Memorabilia" FontSize="12"/>
                        </StackPanel>

                        <!-- Pricing -->
                        <Separator/>
                        <TextBlock Text="Pricing" FontSize="14" FontWeight="SemiBold"/>

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Cost Basis" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding CostBasis}" Watermark="5.00"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Spacing="4">
                                <TextBlock Text="Listing Price" FontWeight="SemiBold" FontSize="12"/>
                                <TextBox Text="{Binding ListingPrice}" Watermark="12.00"/>
                            </StackPanel>
                        </Grid>

                        <!-- Status -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Status" FontWeight="SemiBold" FontSize="12"/>
                            <ComboBox SelectedItem="{Binding Status}" HorizontalAlignment="Stretch">
                                <ComboBoxItem Content="Draft"/>
                                <ComboBoxItem Content="Priced"/>
                                <ComboBoxItem Content="Ready"/>
                                <ComboBoxItem Content="Listed"/>
                            </ComboBox>
                        </StackPanel>

                        <!-- Notes -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Notes" FontWeight="SemiBold" FontSize="12"/>
                            <TextBox Text="{Binding Notes}" TextWrapping="Wrap"
                                     AcceptsReturn="True" MinHeight="60" Watermark="Additional notes..."/>
                        </StackPanel>

                    </StackPanel>
                </ScrollViewer>

                <!-- Save/Cancel Footer -->
                <Border Grid.Row="2" Background="{DynamicResource SystemChromeMediumLowColor}"
                        CornerRadius="0,0,8,8" Padding="16,12">
                    <StackPanel Spacing="8">
                        <!-- Messages -->
                        <TextBlock Text="{Binding EditSuccessMessage}" Foreground="Green" FontSize="12"
                                   IsVisible="{Binding EditSuccessMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        <TextBlock Text="{Binding EditErrorMessage}" Foreground="Red" FontSize="12" TextWrapping="Wrap"
                                   IsVisible="{Binding EditErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                        <!-- Buttons -->
                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                            <Button Grid.Column="0" Content="Save Changes" Command="{Binding SaveEditCommand}"
                                    Classes="accent" HorizontalAlignment="Stretch" Padding="12,8"/>
                            <Button Grid.Column="1" Content="Full Edit..." Command="{Binding OpenFullEditCommand}"
                                    Padding="12,8" ToolTip.Tip="Open comprehensive edit window with all fields"/>
                            <Button Grid.Column="2" Content="Close" Command="{Binding CloseEditPanelCommand}"
                                    Padding="12,8"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
