<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FlipKit.Desktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="900"
             x:Class="FlipKit.Desktop.Views.SettingsView"
             x:DataType="vm:SettingsViewModel">

    <ScrollViewer Padding="24">
        <StackPanel Spacing="24" MaxWidth="700">

            <TextBlock Text="Settings" FontSize="24" FontWeight="Bold"/>

            <!-- API Connections -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="API Connections" FontSize="18" FontWeight="SemiBold"/>

                    <!-- OpenRouter -->
                    <TextBlock Text="OpenRouter API Key" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <DockPanel>
                        <Button DockPanel.Dock="Right" Content="Test" Margin="8,0,0,0"
                                Command="{Binding TestOpenRouterCommand}"
                                IsEnabled="{Binding !IsTestingOpenRouter}"/>
                        <TextBox Text="{Binding OpenRouterApiKey}"
                                 PasswordChar="*" Watermark="sk-or-v1-..."/>
                    </DockPanel>
                    <TextBlock Text="{Binding OpenRouterStatus}" FontSize="12" Opacity="0.7"/>

                    <!-- ImgBB -->
                    <TextBlock Text="ImgBB API Key" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <DockPanel>
                        <Button DockPanel.Dock="Right" Content="Test" Margin="8,0,0,0"
                                Command="{Binding TestImgBBCommand}"
                                IsEnabled="{Binding !IsTestingImgBB}"/>
                        <TextBox Text="{Binding ImgBBApiKey}"
                                 PasswordChar="*" Watermark="Your ImgBB API key"/>
                    </DockPanel>
                    <TextBlock Text="{Binding ImgBBStatus}" FontSize="12" Opacity="0.7"/>

                    <!-- Model Selection -->
                    <TextBlock Text="Default AI Model" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <ComboBox ItemsSource="{Binding ModelOptions}"
                              SelectedItem="{Binding DefaultModel}"
                              HorizontalAlignment="Stretch"/>
                    <TextBlock Text="Free vision models â€” auto falls back to next model on rate limit"
                               FontSize="11" Opacity="0.5" Margin="0,-6,0,0"/>
                </StackPanel>
            </Border>

            <!-- Card Scanning -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Card Scanning" FontSize="18" FontWeight="SemiBold"/>

                    <CheckBox IsChecked="{Binding EnableVariationVerification}"
                              Content="Verify variations against set checklists"/>

                    <CheckBox IsChecked="{Binding AutoApplyHighConfidenceSuggestions}"
                              Content="Auto-apply high-confidence corrections"
                              IsEnabled="{Binding EnableVariationVerification}"/>

                    <CheckBox IsChecked="{Binding RunConfirmationPass}"
                              Content="Run confirmation pass for ambiguous cards"
                              IsEnabled="{Binding EnableVariationVerification}"/>

                    <CheckBox IsChecked="{Binding EnableChecklistLearning}"
                              Content="Auto-learn checklists from saved cards"/>

                    <!-- Concurrent Scans -->
                    <TextBlock Text="Max Concurrent Bulk Scans" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <NumericUpDown Value="{Binding MaxConcurrentScans}"
                                   Minimum="1" Maximum="8" Increment="1"
                                   HorizontalAlignment="Left" Width="100"/>
                    <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        For free models (with :free suffix), use 1 to avoid rate limits.
                        For paid models with credits, use 3-4 for optimal speed.
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Preferences -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Preferences" FontSize="18" FontWeight="SemiBold"/>

                    <CheckBox IsChecked="{Binding IsEbaySeller}" Content="I sell on eBay (enables Terapeak links)"/>

                    <TextBlock Text="Default Shipping Profile" FontWeight="SemiBold"/>
                    <ComboBox SelectedItem="{Binding DefaultShippingProfile}" HorizontalAlignment="Stretch">
                        <x:String>4 oz</x:String>
                        <x:String>8 oz</x:String>
                        <x:String>1 lb</x:String>
                    </ComboBox>

                    <TextBlock Text="Default Condition" FontWeight="SemiBold"/>
                    <ComboBox SelectedItem="{Binding DefaultCondition}" HorizontalAlignment="Stretch">
                        <x:String>Near Mint</x:String>
                        <x:String>Like New</x:String>
                        <x:String>Very Good</x:String>
                        <x:String>Good</x:String>
                        <x:String>Acceptable</x:String>
                    </ComboBox>
                </StackPanel>
            </Border>

            <!-- Financial Settings -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Financial Settings" FontSize="18" FontWeight="SemiBold"/>

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="16">
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Whatnot Fee %" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding WhatnotFeePercent}"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="eBay Fee %" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding EbayFeePercent}"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Default Shipping (PWE)" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding DefaultShippingCostPwe}"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Default Shipping (BMWT)" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding DefaultShippingCostBmwt}"/>

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Price Staleness (days)" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding PriceStalenessThresholdDays}"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Title Templates (SEO Optimization) -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Listing Title Templates" FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.7">
                        Customize how card titles are generated for each platform. Based on WTSCards research,
                        different platforms weight fields differently for SEO (search ranking).
                    </TextBlock>

                    <!-- Active Export Platform -->
                    <TextBlock Text="Active Export Platform" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <ComboBox ItemsSource="{Binding ExportPlatformOptions}"
                              SelectedItem="{Binding ActiveExportPlatform}"
                              HorizontalAlignment="Stretch"/>
                    <TextBlock Text="This platform's template will be used for exports"
                               FontSize="11" Opacity="0.5" Margin="0,-6,0,0"/>

                    <!-- Whatnot Template -->
                    <TextBlock Text="Whatnot Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding WhatnotTitleTemplate}"
                             Watermark="Example: Year Brand Player Parallel"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Optimized for brand + player searches (e.g., "Prizm CJ Stroud")
                    </TextBlock>

                    <!-- eBay Template -->
                    <TextBlock Text="eBay Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding EbayTitleTemplate}"
                             Watermark="Example: Year Manufacturer Brand Player Team"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Comprehensive SEO with manufacturer emphasis
                    </TextBlock>

                    <!-- COMC Template -->
                    <TextBlock Text="COMC Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding ComcTitleTemplate}"
                             Watermark="Example: Year Brand Player Team Parallel"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Check Out My Cards consignment format
                    </TextBlock>

                    <!-- Generic Template -->
                    <TextBlock Text="Generic Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding GenericTitleTemplate}"
                             Watermark="Example: Year Brand Player Parallel"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Balanced format for other platforms
                    </TextBlock>

                    <!-- Help Text (Collapsible) -->
                    <Expander Header="Available Placeholders" Margin="0,8,0,0">
                        <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                Padding="12" CornerRadius="4" Margin="0,8,0,0">
                            <TextBlock Text="{Binding PlaceholderHelpText}"
                                       FontSize="11" FontFamily="Consolas"
                                       TextWrapping="Wrap"/>
                        </Border>
                    </Expander>

                    <!-- Validation & Preview -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                        <Button Content="Validate Template" Command="{Binding ValidateCurrentTemplateCommand}"
                                Padding="12,6"/>
                        <Button Content="Preview with Sample Card" Command="{Binding GeneratePreviewCommand}"
                                Padding="12,6"/>
                        <Button Content="Reset to Defaults" Command="{Binding ResetTitleTemplatesCommand}"
                                Padding="12,6"/>
                    </StackPanel>

                    <!-- Validation Message -->
                    <TextBlock Text="{Binding TemplateValidationMessage}"
                               IsVisible="{Binding TemplateValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               FontSize="12" Foreground="Orange" TextWrapping="Wrap"/>

                    <!-- Preview -->
                    <TextBlock Text="{Binding TemplatePreview}"
                               IsVisible="{Binding TemplatePreview, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               FontSize="12" Foreground="Blue" TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- Search Query Templates (Pricing Research) -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Search Query Templates" FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.7">
                        Customize how search queries are built for pricing research (Terapeak/eBay).
                        Exclude overly specific fields (CardNumber, Serial) to get broader search results.
                    </TextBlock>

                    <!-- Terapeak Search Template -->
                    <TextBlock Text="Terapeak Search Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding TerapeakSearchTemplate}"
                             Watermark="Example: Year Brand Player Parallel"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Used when clicking "Open Terapeak" in Pricing view
                    </TextBlock>

                    <!-- eBay Search Template -->
                    <TextBlock Text="eBay Sold Search Template" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding EbaySearchTemplate}"
                             Watermark="Example: Year Manufacturer Brand Player Team"
                             TextWrapping="Wrap" AcceptsReturn="False"/>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,-6,0,0">
                        Used when clicking "Open eBay Sold" in Pricing view
                    </TextBlock>

                    <!-- Validation & Preview -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                        <Button Content="Validate Templates" Command="{Binding ValidateSearchTemplatesCommand}"
                                Padding="12,6"/>
                        <Button Content="Preview with Sample Card" Command="{Binding GenerateSearchPreviewCommand}"
                                Padding="12,6"/>
                        <Button Content="Reset to Defaults" Command="{Binding ResetSearchTemplatesCommand}"
                                Padding="12,6"/>
                    </StackPanel>

                    <!-- Validation Message -->
                    <TextBlock Text="{Binding SearchTemplateValidationMessage}"
                               IsVisible="{Binding SearchTemplateValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               FontSize="12" Foreground="Orange" TextWrapping="Wrap"/>

                    <!-- Preview -->
                    <TextBlock Text="{Binding SearchTemplatePreview}"
                               IsVisible="{Binding SearchTemplatePreview, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               FontSize="12" Foreground="Blue" TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- Your Data -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Your Data" FontSize="18" FontWeight="SemiBold"/>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Cards in database:" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CardCount}" FontWeight="Bold" VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Database:" VerticalAlignment="Center" FontSize="12" Opacity="0.7"/>
                        <TextBlock Text="{Binding DbPath}" FontSize="12" Opacity="0.7" VerticalAlignment="Center"/>
                    </StackPanel>

                    <Button Content="Open Data Folder" Command="{Binding OpenDataFolderCommand}"/>
                </StackPanel>
            </Border>

            <!-- Data Access Mode -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20">
                <StackPanel Spacing="12">
                    <TextBlock Text="Data Access Mode" FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.7">
                        FlipKit automatically detects whether to use local database (fast, direct access) or remote API (Tailscale network access).
                    </TextBlock>

                    <!-- Current Mode Status -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                        <TextBlock Text="Current Mode:" VerticalAlignment="Center" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding DataAccessMode}" VerticalAlignment="Center">
                            <TextBlock.Foreground>
                                <SolidColorBrush Color="{Binding DataAccessModeColor}"/>
                            </TextBlock.Foreground>
                        </TextBlock>
                    </StackPanel>

                    <!-- API Server URL (Optional) -->
                    <TextBlock Text="API Server URL (Optional for Remote Access)" FontWeight="SemiBold" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding SyncServerUrl}"
                             Watermark="http://100.64.1.5:5000"/>
                    <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.5" Margin="0,-6,0,0">
                        Leave empty or use localhost for local database. Enter Tailscale IP for remote API access.
                    </TextBlock>

                    <!-- How it works -->
                    <Border Background="{DynamicResource SystemChromeLowColor}"
                            CornerRadius="6" Padding="12" Margin="0,8,0,0">
                        <StackPanel Spacing="6">
                            <TextBlock Text="ðŸ“‹ How It Works" FontSize="13" FontWeight="SemiBold"/>
                            <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.8">
                                â€¢ <Run FontWeight="SemiBold">Empty/Localhost:</Run> Uses local SQLite database (fast, direct)
                                <LineBreak/>
                                â€¢ <Run FontWeight="SemiBold">Tailscale IP:</Run> Uses remote API via FlipKit.Api server
                                <LineBreak/>
                                <LineBreak/>
                                <Run FontWeight="SemiBold">To access remotely:</Run>
                                <LineBreak/>
                                1. Run FlipKit.Api on main computer: cd FlipKit.Api &amp;&amp; dotnet run
                                <LineBreak/>
                                2. Get Tailscale IP: tailscale ip -4
                                <LineBreak/>
                                3. Enter http://[TAILSCALE_IP]:5000 above and save
                                <LineBreak/>
                                4. Restart app - all data operations now use API
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Save -->
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Button Content="Save Settings" Command="{Binding SaveSettingsCommand}"
                        Classes="accent" Padding="24,10"/>
                <TextBlock Text="{Binding SaveMessage}" VerticalAlignment="Center"
                           Foreground="Green" FontSize="14"/>
            </StackPanel>

            <!-- Legal Disclaimer -->
            <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                    CornerRadius="8" Padding="20" Background="{DynamicResource SystemChromeLowColor}">
                <StackPanel Spacing="8">
                    <TextBlock Text="âš ï¸ Important Legal Notice" FontSize="16" FontWeight="SemiBold"/>
                    <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.85">
                        <Run FontWeight="Bold">For Educational Use Only.</Run>
                        FlipKit is provided "AS IS" without warranties of any kind. No warranties are implied regarding the accuracy of AI card identification, pricing data, financial calculations, or any other information.
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.85">
                        <Run FontWeight="Bold">Use at Your Own Risk.</Run>
                        Always verify all card identifications, prices, and financial data independently. AI-generated content may contain errors. Not intended for professional accounting, tax, or financial advice.
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.7" Margin="0,4,0,0">
                        By using this software, you accept all responsibility for verifying data accuracy and compliance with applicable laws. See full disclaimer in README.md.
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>
